<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimador de Renta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .form-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            overflow-y: auto;
            flex: 1;
            padding-right: 8px;
        }

        .form-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .form-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .form-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
        }

        input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        button {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #result {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 12px;
            min-height: 30px;
            border-left: 5px solid #667eea;
        }

        .result-content {
            display: grid;
            gap: 20px;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .result-icon.price {
            background: #e3f2fd;
            color: #1976d2;
        }

        .result-icon.size {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .result-icon.sqm {
            background: #fff3e0;
            color: #f57c00;
        }

        .result-text {
            flex: 1;
        }

        .result-label {
            color: #999;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .result-value {
            color: #333;
            font-size: 20px;
            font-weight: 700;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #d32f2f;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 900px) {
            .form-wrapper {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .container {
                padding: 30px;
                max-width: 100%;
            }

            h1 {
                font-size: 24px;
            }

            .subtitle {
                font-size: 11px;
                margin-bottom: 15px;
            }

            label {
                font-size: 11px;
            }

            input {
                padding: 8px 10px;
                font-size: 13px;
            }

            button {
                font-size: 13px;
                padding: 10px;
            }

            .result-value {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè† Estimador de Renta</h1>
        <p class="subtitle">Descubre el precio de renta y tama√±o de apartamentos</p>

        <div class="form-wrapper">
            <div class="form-group">
                <label for="address">Ingresa una direcci√≥n:</label>
                <input id="address" type="text" placeholder="Ej: Lima, Per√∫" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="desired_sqm">¬øCu√°ntos m¬≤ quieres rentar?</label>
                <input id="desired_sqm" type="number" min="1" step="0.1" placeholder="Ej: 50" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="property_price">Precio de la vivienda (PEN)</label>
                <input id="property_price" type="number" min="0" step="0.01" placeholder="Ej: 300000" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="down_payment">Pago inicial (PEN) <span style="color: #999; font-weight: 400;">- 10% por defecto</span></label>
                <input id="down_payment" type="number" min="0" step="0.01" placeholder="Ej: 60000" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="annual_interest">Tasa de inter√©s anual (%)</label>
                <input id="annual_interest" type="number" min="0" step="0.01" placeholder="Ej: 7.5" autocomplete="off" value="10">
            </div>

            <div class="form-group">
                <label for="loan_term">Plazo del pr√©stamo (a√±os)</label>
                <input id="loan_term" type="number" min="0" step="1" placeholder="Ej: 20" autocomplete="off" value="20">
            </div>

            <div class="form-group">
                <label for="maintenance_annual">Costo de mantenimiento anual (PEN)</label>
                <input id="maintenance_annual" type="number" min="0" step="0.01" placeholder="Ej: 1200" autocomplete="off">
            </div>

            <div class="form-group">
                <label for="anual_rev">Revalorizacion anual</label>
                <input id="anual_rev" type="number" min="0" step="1" placeholder="Ej: 3" autocomplete="off" value="3">
            </div>

        </div>

        <div class="button-group">
            <button onclick="getEstimation()">Calcular</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        // Auto-calculate down payment as 10% of property price
        document.getElementById('property_price').addEventListener('input', function(){
            const propertyPrice = Number(this.value || 0);
            if (propertyPrice > 0) {
                const downPaymentField = document.getElementById('down_payment');
                // Only auto-fill if the field is empty or has the old calculated value
                if (!downPaymentField.value || downPaymentField.dataset.autoCalculated === 'true') {
                    const calculatedDownPayment = propertyPrice * 0.1;
                    downPaymentField.value = calculatedDownPayment.toFixed(2);
                    downPaymentField.dataset.autoCalculated = 'true';
                }
            }
        });

        // Allow user to manually override the down payment
        document.getElementById('down_payment').addEventListener('input', function(){
            this.dataset.autoCalculated = 'false';
        });

        async function getEstimation() {
            const addr = document.getElementById("address").value;
            const desiredInput = document.getElementById("desired_sqm");
            const desired = desiredInput ? desiredInput.value : '';
            const resultElement = document.getElementById("result");
            const propertyPrice = Number(document.getElementById('property_price').value || 0);
            const downPayment = Number(document.getElementById('down_payment').value || 0);
            const annualInterest = Number(document.getElementById('annual_interest').value || 0);
            const loanTermYears = Number(document.getElementById('loan_term').value || 0);
            const maintenanceAnnual = Number(document.getElementById('maintenance_annual').value || 0);
            const anualRev = Number(document.getElementById('anual_rev').value || 0);




            if (!addr.trim()) {
                resultElement.innerHTML = '<div class="error">Por favor ingresa una direcci√≥n</div>';
                return;
            }

            if (!desired || isNaN(desired) || Number(desired) <= 0) {
                resultElement.innerHTML = '<div class="error">Por favor ingresa una cantidad v√°lida de metros cuadrados</div>';
                return;
            }

            const desiredMeters = Number(desired);

            resultElement.innerHTML = '<div class="loading">‚è≥ Buscando informaci√≥n...</div>';

            const response = await fetch("/api/rent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address: addr })
            });

            const data = await response.json();

            if (data.error) {
                resultElement.innerHTML = `<div class="error">‚ö†Ô∏è Error: ${data.error}</div>`;
                return;
            }

            // Parse price_per_sqm safely
            function parseNumber(str) {
                if (!str) return NaN;
                const cleaned = String(str).replace(/[^0-9,.-]/g, '').replace(/,/g, '.');
                return parseFloat(cleaned);
            }

            const pricePerSqm = parseNumber(data.price_per_sqm);

            if (!isFinite(pricePerSqm) || pricePerSqm <= 0) {
                resultElement.innerHTML = `<div class="error">No se pudo obtener un precio por m¬≤ v√°lido desde el servidor.</div>`;
                return;
            }

            // Validate mortgage inputs (property price and term required to compute mortgage)
            if (!(propertyPrice > 0) || !(loanTermYears > 0) || !(annualInterest >= 0)) {
                resultElement.innerHTML = '<div class="error">Por favor ingresa precio de vivienda, tasa de inter√©s y plazo v√°lidos para calcular la cuota.</div>';
                return;
            }

            // Check that down payment is not greater than property price
            if (downPayment > propertyPrice) {
                resultElement.innerHTML = '<div class="error">El pago inicial no puede ser mayor que el precio de la vivienda.</div>';
                return;
            }

            const totalRent = pricePerSqm * desiredMeters; // monthly rent assumed

            /*console.log(anualRev);*/

            // Calculate loan amount after down payment
            const loanAmount = propertyPrice - downPayment;

            // Mortgage monthly payment calculation
            function monthlyMortgage(P, annualPct, years){
                const monthlyRate = annualPct / 100 / 12;
                const n = Math.round(years * 12);
                if (monthlyRate === 0) return P / n;
                const pow = Math.pow(1 + monthlyRate, n);
                return P * (monthlyRate * pow) / (pow - 1);
            }

            const monthlyMortgagePayment = monthlyMortgage(loanAmount, annualInterest, loanTermYears);
            const monthlyMaintenance = maintenanceAnnual / 12;
            const netMonthlyIncome = totalRent - monthlyMortgagePayment - monthlyMaintenance - 0.05 * totalRent; // assuming 5% other costs


            /* Cash flow Calulation */
            const discountRate = 7 / 100; // 7% discount rate
            const netAnnualIncome = netMonthlyIncome * 12;
            const investmentTime = 5; // years

            /* Cash flow from Rent */
            CF = 0 ; 
            let cashFlowsRentDiscount = [];
            let cashFlowInformation= [] ;
            cashFlowInformation.push(-downPayment);
            for (let t = 2; t <= investmentTime; t++) {
                const Ct = netAnnualIncome / Math.pow(1 + discountRate , t);
                cashFlowsRentDiscount.push(Ct);
                cashFlowInformation.push(netAnnualIncome);
                CF += Ct;
            }

            /* Final Sale Value after 5 years */
            const futurePropertyValue = propertyPrice * Math.pow(1 + (anualRev / 100), investmentTime);
 
            /* Debt Remaining after 5 years */
            const monthlyDuration = Math.round(investmentTime * 12)
            const monthlyRate = annualInterest / 100 / 12;
            const debtRemaining = loanAmount * Math.pow(1 + monthlyRate, monthlyDuration ) -
                 monthlyMortgagePayment * (Math.pow(1 + monthlyRate, monthlyDuration) - 1) / monthlyRate;

            /* Cash Flow from Property Sale */
            const cashFlowPropertySaleDiscount = (futurePropertyValue- debtRemaining )/ Math.pow(1 + discountRate, investmentTime);
            CF += cashFlowPropertySaleDiscount;
            cashFlowInformation.push(futurePropertyValue- debtRemaining);

            /* Net present Value */
            const NPV = CF - downPayment;


            // Prepare result object and redirect to results page
            const resultObj = {
                price_per_sqm: pricePerSqm,
                desired_meters: desiredMeters,
                total_rent_monthly: totalRent,
                down_payment: downPayment,
                loan_amount: loanAmount,
                monthly_mortgage_payment: monthlyMortgagePayment,
                monthly_maintenance: monthlyMaintenance,
                net_monthly_income: netMonthlyIncome,
                debt_remaining: debtRemaining,
                future_property_value:futurePropertyValue,
                net_present_value: NPV,
                cash_flow_information: cashFlowInformation
            };

            // store raw numbers for results page and navigate
            sessionStorage.setItem('rent_results', JSON.stringify(resultObj));
            window.location.href = '/results';
        }

        // Submit on Enter for relevant inputs
        const enterSubmitIds = ['address','desired_sqm','property_price','down_payment','annual_interest','loan_term','maintenance_annual'];
        enterSubmitIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('keypress', function(event){
                    if (event.key === 'Enter'){
                        event.preventDefault();
                        getEstimation();
                    }
                });
            }
        });
    </script>
</body>
</html>
